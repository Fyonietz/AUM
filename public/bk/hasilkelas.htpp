<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presentasi Hasil Per Kelas</title>
  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      padding: 20px;
      overflow-x: hidden; /* Menghindari overflow horizontal global */
      margin: 0;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #4a148c;
    }
    
    .register-user {
      display: flex;
      justify-content: center;
      flex-wrap: wrap; /* Agar elemen bisa wrap di mobile */
      gap: 10px; /* Menambahkan jarak antar elemen */
      max-width: 100%;
    }
    
    select {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      outline: none;
      min-width: 200px;
      max-width: 100%; /* Agar select box tidak meluap */
      box-sizing: border-box;
    }
    
    button {
      margin-left: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #8e44ad, #6c3483);
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
      max-width: 100%; /* Menyesuaikan button dengan lebar layar */
      box-sizing: border-box;
    }
    
    button:hover {
      background: linear-gradient(135deg, #9b59b6, #7d3c98);
    }
    
    /* Tabel */
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      margin-top: 20px;
      table-layout: fixed; /* Membuat tabel menyesuaikan lebar kontainer */
    }
    
    th, td {
      padding: 12px 16px;
      text-align: center;
      border: 1px solid #ddd;
      word-wrap: break-word; /* Agar teks dalam sel tidak meluap */
      overflow: hidden;
      text-overflow: ellipsis; /* Agar teks panjang terpotong */
    }
    
    th {
      background-color: #8e44ad;
      color: white;
    }
    
    tr:nth-child(even) {
      background-color: #f3e8ff;
    }

    /* Media Query untuk perangkat dengan lebar layar lebih kecil */
    @media (max-width: 600px) {
      .register-user {
        flex-direction: column; /* Susun elemen secara vertikal di perangkat kecil */
        align-items: center;
      }

      select, button {
        width: 100%; /* Menyesuaikan ukuran select dan button dengan lebar layar */
        margin: 5px 0; /* Memberikan jarak antar elemen */
      }

      table {
        width: 100%; /* Membuat tabel menyesuaikan lebar layar */
      }

      th, td {
        font-size: 12px; /* Menyesuaikan ukuran font untuk perangkat kecil */
        padding: 8px 10px; /* Mengurangi padding pada perangkat kecil */
      }
    }
  </style>
</head>
<body>

  <h1>Presentasi Hasil Per Kelas</h1>

  <div class="register-user">
    <select id="kelasSelect">
      <option value="">-- Pilih Kelas --</option>
    </select>
    <button onclick="tampilkanHasil()">Tampilkan</button>
  </div>

  <div id="hasilContainer"><p>Silakan pilih kelas lalu klik Tampilkan.</p></div>

  <div id="tabelContainer"></div>

  <script>
    let dataHasil = [];

    async function loadData() {
      const kelasSelect = document.getElementById('kelasSelect');
      const hasilContainer = document.getElementById('hasilContainer');

      hasilContainer.innerHTML = "<p>Loading data...</p>";

      try {
        const res = await fetch('/api/hasil');
        if (!res.ok) throw new Error('Gagal mengambil data');
        const data = await res.json();
        dataHasil = data;

        // Ambil kelas unik
        const kelasUnik = [...new Set(data.map(item => item.kelas))].sort();

        kelasSelect.innerHTML = `<option value="">-- Pilih Kelas --</option>`;
        kelasUnik.forEach(kelas => {
          const opt = document.createElement('option');
          opt.value = kelas;
          opt.textContent = kelas;
          kelasSelect.appendChild(opt);
        });

        hasilContainer.innerHTML = "<p>Silakan pilih kelas lalu klik Tampilkan.</p>";
      } catch (err) {
        hasilContainer.innerHTML = `<p>Error: ${err.message}</p>`;
      }
    }

    function tampilkanHasil() {
      const kelasTerpilih = document.getElementById('kelasSelect').value;
      const hasilContainer = document.getElementById('hasilContainer');

      if (!kelasTerpilih) {
        hasilContainer.innerHTML = "<p>Silakan pilih kelas terlebih dahulu.</p>";
        return;
      }

      const filtered = dataHasil.filter(item => item.kelas === kelasTerpilih);

      if (filtered.length === 0) {
        hasilContainer.innerHTML = "<p>Tidak ada data untuk kelas ini.</p>";
        return;
      }

      // Hitung jumlah soal dipilih per bidang masalah
      const bidangCount = {};
      filtered.forEach(item => {
        const bidang = item.soal_masalah_kategori || 'Tidak Diketahui';
        bidangCount[bidang] = (bidangCount[bidang] || 0) + 1;
      });

      const total = filtered.length;

      // Bangun tabel presentasi (%)
      let html = `<h2>Rekap Presentasi Kelas: ${kelasTerpilih}</h2>`;
      html += `<table>
                <tr>
                  <th>Bidang Masalah</th>
                  <th>Jumlah Soal Dipilih</th>
                  <th>Persentase</th>
                </tr>`;

      for (const bidang in bidangCount) {
        const jumlah = bidangCount[bidang];
        const persen = ((jumlah / total) * 100).toFixed(2) + '%';
        html += `<tr>
                  <td>${bidang}</td>
                  <td>${jumlah}</td>
                  <td>${persen}</td>
                </tr>`;
      }
      html += `</table>`;

      document.getElementById("tabelContainer").innerHTML = html;
    }

    window.onload = loadData;
  </script>

</body>
</html>
